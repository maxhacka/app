# Сервис "Staff"

Сервис "Staff" предоставляет API для управления студентами и преподавателями, а также статистикой и интеграцией с ботом.

## API Эндпоинты

### Студенты

- `GET /api/staff/students`:
  - Получить список всех студентов.
  - Параметры запроса:
    - `group_name` (опционально, str) - фильтр по названию группы
    - `status` (опционально, str) - фильтр по статусу студента
    - `faculty` (опционально, str) - фильтр по факультету
    - `course` (опционально, int) - фильтр по курсу
    - `student_number` (опционально, str) - поиск по номеру студенческого билета (если указан, возвращает только одного студента)
    - `max_user_id` (опционально, int) - поиск по max_user_id (если указан, возвращает только одного студента)
    - `skip` (по умолчанию: 0) - количество пропускаемых записей
    - `limit` (по умолчанию: 100) - лимит записей
  - Если указан `student_number` или `max_user_id`, возвращает список с одним элементом или пустой список.
  - Возвращает список объектов `Student`.
  - Требует аутентификации.

- `GET /api/staff/students/{student_id}`:
  - Получить студента по его ID.
  - Возвращает объект `Student`.
  - Выдает ошибку 404, если студент не найден.
  - Требует аутентификации.

- `POST /api/staff/students`:
  - Создать нового студента.
  - Принимает объект `StudentCreate` с полями:
    - `student_number` (str) - номер студенческого билета (уникальный)
    - `name` (str) - имя студента
    - `group_name` (str) - название группы
    - `email` (str, опционально) - email студента
    - `phone` (str, опционально) - телефон в формате +7XXXXXXXXXX (уникальный)
    - `status` (str, по умолчанию: "active") - статус студента
    - `enrollment_year` (int, опционально) - год поступления
    - `faculty` (str, опционально) - факультет
    - `specialization` (str, опционально) - специальность
    - `course` (int, опционально) - курс
    - `max_user_id` (int, опционально) - ID пользователя в основной системе
  - Проверка уникальности: номер студенческого билета и телефон должны быть уникальными.
  - Возвращает созданный объект `Student`.
  - Выдает ошибку 400 при нарушении уникальности или неверном формате телефона.
  - Требует аутентификации.

- `PUT /api/staff/students/{student_id}`:
  - Обновить существующего студента по его ID.
  - Принимает объект `StudentUpdate` с опциональными полями (все поля из `StudentCreate`).
  - Проверка уникальности: при обновлении номера студенческого билета или телефона проверяется их уникальность.
  - Возвращает обновленный объект `Student`.
  - Выдает ошибку 404, если студент не найден.
  - Выдает ошибку 400 при нарушении уникальности или неверном формате телефона.
  - Требует аутентификации.

- `DELETE /api/staff/students/{student_id}`:
  - Удалить студента по его ID.
  - Возвращает сообщение об успешном удалении: `{"message": "Student deleted successfully"}`.
  - Выдает ошибку 404, если студент не найден.
  - Требует аутентификации.

- `POST /api/staff/students/update-max-id`:
  - Обновить max_user_id студента по номеру телефона (для интеграции с ботом).
  - Принимает объект `UpdateMaxIdByPhone` с полями:
    - `phone` (str) - номер телефона в формате +7XXXXXXXXXX
    - `max_user_id` (int, опционально) - новое значение max_user_id (если None, значение очищается)
  - Возвращает обновленный объект `Student`.
  - Выдает ошибку 404, если студент с таким телефоном не найден.
  - Требует аутентификации.

### Преподаватели

- `GET /api/staff/teachers`:
  - Получить список всех преподавателей.
  - Параметры запроса:
    - `department` (опционально, str) - фильтр по кафедре
    - `status` (опционально, str) - фильтр по статусу преподавателя
    - `teacher_number` (опционально, str) - поиск по номеру преподавательского удостоверения (если указан, возвращает только одного преподавателя)
    - `max_user_id` (опционально, int) - поиск по max_user_id (если указан, возвращает только одного преподавателя)
    - `skip` (по умолчанию: 0) - количество пропускаемых записей
    - `limit` (по умолчанию: 100) - лимит записей
  - Если указан `teacher_number` или `max_user_id`, возвращает список с одним элементом или пустой список.
  - Возвращает список объектов `Teacher`.
  - Требует аутентификации.

- `GET /api/staff/teachers/{teacher_id}`:
  - Получить преподавателя по его ID.
  - Возвращает объект `Teacher`.
  - Выдает ошибку 404, если преподаватель не найден.
  - Требует аутентификации.

- `POST /api/staff/teachers`:
  - Создать нового преподавателя.
  - Принимает объект `TeacherCreate` с полями:
    - `teacher_number` (str) - номер преподавательского удостоверения (уникальный)
    - `name` (str) - имя преподавателя
    - `email` (str, опционально) - email преподавателя
    - `phone` (str, опционально) - телефон в формате +7XXXXXXXXXX (уникальный)
    - `status` (str, по умолчанию: "active") - статус преподавателя
    - `department` (str, опционально) - кафедра
    - `position` (str, опционально) - должность
    - `academic_degree` (str, опционально) - ученая степень
    - `subjects` (str, опционально) - преподаваемые предметы
    - `max_user_id` (int, опционально) - ID пользователя в основной системе
  - Проверка уникальности: номер преподавательского удостоверения и телефон должны быть уникальными.
  - Возвращает созданный объект `Teacher`.
  - Выдает ошибку 400 при нарушении уникальности или неверном формате телефона.
  - Требует аутентификации.

- `PUT /api/staff/teachers/{teacher_id}`:
  - Обновить существующего преподавателя по его ID.
  - Принимает объект `TeacherUpdate` с опциональными полями (все поля из `TeacherCreate`).
  - Проверка уникальности: при обновлении номера преподавательского удостоверения или телефона проверяется их уникальность.
  - Возвращает обновленный объект `Teacher`.
  - Выдает ошибку 404, если преподаватель не найден.
  - Выдает ошибку 400 при нарушении уникальности или неверном формате телефона.
  - Требует аутентификации.

- `DELETE /api/staff/teachers/{teacher_id}`:
  - Удалить преподавателя по его ID.
  - Возвращает сообщение об успешном удалении: `{"message": "Teacher deleted successfully"}`.
  - Выдает ошибку 404, если преподаватель не найден.
  - Требует аутентификации.

- `POST /api/staff/teachers/update-max-id`:
  - Обновить max_user_id преподавателя по номеру телефона (для интеграции с ботом).
  - Принимает объект `UpdateMaxIdByPhone` с полями:
    - `phone` (str) - номер телефона в формате +7XXXXXXXXXX
    - `max_user_id` (int, опционально) - новое значение max_user_id (если None, значение очищается)
  - Возвращает обновленный объект `Teacher`.
  - Выдает ошибку 404, если преподаватель с таким телефоном не найден.
  - Требует аутентификации.

### Справочники

- `GET /api/staff/groups`:
  - Получить список всех уникальных групп студентов.
  - Возвращает объект с полем `groups` - массив названий групп, отсортированный по алфавиту.
  - Требует аутентификации.

- `GET /api/staff/departments`:
  - Получить список всех уникальных кафедр преподавателей.
  - Возвращает объект с полем `departments` - массив названий кафедр, отсортированный по алфавиту.
  - Требует аутентификации.

### Статистика

- `GET /api/staff/statistics`:
  - Получить статистику по сотрудникам.
  - Возвращает объект `StaffStatistics` с полями:
    - `total_students` - общее количество студентов
    - `total_teachers` - общее количество преподавателей
    - `active_students` - количество активных студентов
    - `active_teachers` - количество активных преподавателей
    - `students_by_course` - словарь с количеством студентов по курсам
    - `students_by_faculty` - словарь с количеством студентов по факультетам
  - Требует аутентификации.

### Служебные эндпоинты

- `GET /`:
  - Информация о сервисе.
  - Возвращает объект с полями: `service`, `version`, `status`.

- `GET /health`:
  - Проверка здоровья сервиса.
  - Возвращает объект с полем `status: "healthy"`.

## Особенности

- **Валидация телефонов**: Телефоны должны быть в формате `+7XXXXXXXXXX` (11 цифр после +7). Валидация выполняется автоматически при создании и обновлении.
- **Уникальность**: 
  - Номера студенческих билетов и преподавательских удостоверений должны быть уникальными
  - Телефоны должны быть уникальными (если указаны)
- **Интеграция с ботом**: Эндпоинты `update-max-id` позволяют обновлять `max_user_id` по номеру телефона для интеграции с Telegram ботом.
- **Поиск**: Поддерживается поиск студентов и преподавателей по номеру документа или `max_user_id` через параметры запроса.
- **Статусы**: По умолчанию статус устанавливается в "active" для новых записей.
- **Справочники**: Доступны эндпоинты для получения списков всех групп и кафедр для использования в формах и фильтрах.
- **Аутентификация**: Все эндпоинты требуют аутентификации через токен (кроме служебных эндпоинтов).
- **Обработка ошибок**: При нарушении уникальности или неверном формате данных возвращается ошибка 400 с описанием проблемы.
