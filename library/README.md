# Сервис "Library"

Сервис "Library" предоставляет API для управления книгами, загрузки PDF файлов и статистики библиотеки.

## API Эндпоинты

### Книги

- `GET /api/books`:
  - Получить список всех книг.
  - Параметры запроса:
    - `category` (опционально, str) - фильтр по категории книги
    - `author` (опционально, str) - фильтр по автору (поиск по частичному совпадению, регистронезависимый)
    - `search` (опционально, str) - поиск по названию, автору или описанию (регистронезависимый)
    - `is_electronic` (опционально, bool) - фильтр по типу книги (True - только электронные, False - только бумажные)
    - `skip` (по умолчанию: 0) - количество пропускаемых записей
    - `limit` (по умолчанию: 100) - лимит записей
  - Возвращает список объектов `Book`.
  - Требует аутентификации.

- `GET /api/books/{book_id}`:
  - Получить книгу по ее ID.
  - Возвращает объект `Book`.
  - Выдает ошибку 404, если книга не найдена.
  - Требует аутентификации.

- `POST /api/books`:
  - Создать новую книгу.
  - Принимает объект `BookCreate` с полями:
    - `isbn` (str, опционально) - ISBN книги (уникальный)
    - `title` (str) - название книги
    - `author` (str) - автор книги
    - `publisher` (str, опционально) - издательство
    - `year` (int, опционально) - год издания
    - `category` (str) - категория книги
    - `language` (str, по умолчанию: "ru") - язык книги
    - `pages` (int, опционально) - количество страниц
    - `description` (str, опционально) - описание книги
    - `cover_url` (str, опционально) - URL обложки книги
    - `pdf_url` (str, опционально) - URL PDF файла книги
    - `total_copies` (int, по умолчанию: 1) - общее количество экземпляров
    - `available_copies` (int, по умолчанию: 1) - количество доступных экземпляров
    - `is_electronic` (bool, по умолчанию: False) - является ли книга только электронной
  - Возвращает созданный объект `Book`.
  - Требует аутентификации.

- `PUT /api/books/{book_id}`:
  - Обновить существующую книгу по ее ID.
  - Принимает объект `BookUpdate` с опциональными полями (все поля из `BookCreate`).
  - Возвращает обновленный объект `Book`.
  - Выдает ошибку 404, если книга не найдена.
  - Требует аутентификации.

- `DELETE /api/books/{book_id}`:
  - Удалить книгу по ее ID.
  - При удалении также удаляет PDF файл с диска, если он существует.
  - Возвращает сообщение об успешном удалении: `{"message": "Book deleted successfully"}`.
  - Выдает ошибку 404, если книга не найдена.
  - Требует аутентификации.

- `POST /api/books/{book_id}/upload-pdf`:
  - Загрузить PDF файл книги на сервер.
  - Принимает multipart/form-data с полем:
    - `file` - PDF файл для загрузки
  - Валидация: файл должен иметь расширение `.pdf`.
  - Автоматически обновляет поле `pdf_url` книги.
  - Если у книги нет бумажных экземпляров (`total_copies == 0`), автоматически устанавливает `is_electronic = True`.
  - Возвращает обновленный объект `Book` с новым `pdf_url`.
  - Выдает ошибку 400, если файл не является PDF.
  - Выдает ошибку 404, если книга не найдена.
  - Выдает ошибку 500 при ошибке загрузки файла.
  - Требует аутентификации.

### Статистика

- `GET /api/statistics`:
  - Получить статистику по библиотеке.
  - Возвращает объект `LibraryStatistics` с полями:
    - `total_books` - общее количество книг
    - `total_copies` - общее количество экземпляров всех книг
    - `available_copies` - общее количество доступных экземпляров
    - `books_by_category` - словарь с количеством книг по категориям

### Служебные эндпоинты

- `GET /`:
  - Информация о сервисе.
  - Возвращает объект с полями: `service`, `version`, `status`.

- `GET /health`:
  - Проверка здоровья сервиса.
  - Возвращает объект с полем `status: "healthy"`.

## Особенности

- **Управление файлами**: Сервис поддерживает загрузку PDF файлов книг. Файлы сохраняются в директории `uploads/books/` с уникальными именами на основе UUID.
- **Электронные и бумажные книги**: Книги могут быть как электронными (только PDF), так и бумажными (с физическими экземплярами), или комбинированными.
- **Автоматическое определение типа**: При загрузке PDF файла, если у книги нет бумажных экземпляров (`total_copies == 0`), автоматически устанавливается флаг `is_electronic = True`.
- **Поиск**: Поддерживается полнотекстовый поиск по названию, автору и описанию книги (регистронезависимый).
- **Фильтрация**: Доступна фильтрация по категории, автору, типу книги (электронная/бумажная).
- **Управление экземплярами**: Каждая книга может иметь несколько экземпляров с отслеживанием доступных и общих копий.
- **Статические файлы**: Загруженные PDF файлы доступны через статический маршрут `/uploads/books/{filename}`.
- **Аутентификация**: Все эндпоинты требуют аутентификации через токен (кроме служебных эндпоинтов).
- **Удаление файлов**: При удалении книги автоматически удаляется связанный PDF файл с диска, если он существует.
