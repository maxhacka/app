# Сервис "Auth"

Сервис "Auth" предоставляет API для аутентификации, управления сессиями и администраторами.

## API Эндпоинты

### Аутентификация

- `POST /api/auth/login`:
  - Аутентификация администратора.
  - Принимает объект `LoginRequest` с полями:
    - `username` (str) - имя пользователя
    - `password` (str) - пароль
  - Возвращает объект `LoginResponse` с полями:
    - `access_token` - JWT токен доступа
    - `token_type` - тип токена ("bearer")
    - `expires_in` - время жизни токена в секундах (по умолчанию 86400 секунд = 24 часа)
    - `user` - объект `Admin` с информацией об администраторе
  - Создает новую сессию в базе данных.
  - Выдает ошибку 401 при неверных учетных данных.

- `POST /api/auth/logout`:
  - Выход из системы (удаление сессии).
  - Принимает параметр `token` (str) - токен для удаления.
  - Возвращает сообщение об успешном выходе: `{"message": "Logged out successfully"}`.

- `POST /api/auth/verify`:
  - Проверка валидности токена.
  - Принимает объект `VerifyTokenRequest` с полем:
    - `token` (str) - токен для проверки
  - Возвращает объект `VerifyTokenResponse` с полями:
    - `valid` (bool) - валидность токена
    - `user_id` (int, опционально) - ID пользователя
    - `user_type` (str, опционально) - тип пользователя ("admin")
    - `username` (str, опционально) - имя пользователя
  - Проверяет как валидность JWT токена, так и наличие активной сессии в базе данных.

- `POST /api/auth/refresh`:
  - Обновление access-токена.
  - Принимает параметр `token` (str) - старый токен для обновления.
  - Возвращает объект `Token` с полями:
    - `access_token` - новый JWT токен доступа
    - `token_type` - тип токена ("bearer")
    - `expires_in` - время жизни токена в секундах
  - Удаляет старую сессию и создает новую с обновленным токеном.
  - Выдает ошибку 401 при невалидном токене.

### Администраторы

- `GET /api/admins`:
  - Получить список всех администраторов.
  - Параметры запроса:
    - `skip` (по умолчанию: 0) - количество пропускаемых записей
    - `limit` (по умолчанию: 100) - лимит записей
  - Возвращает список объектов `Admin`.

- `GET /api/admins/{admin_id}`:
  - Получить администратора по его ID.
  - Возвращает объект `Admin`.
  - Выдает ошибку 404, если администратор не найден.

- `POST /api/admins`:
  - Создать нового администратора.
  - Принимает объект `AdminCreate` с полями:
    - `username` (str) - имя пользователя (уникальное)
    - `name` (str) - имя администратора
    - `role` (str, по умолчанию: "admin") - роль администратора
    - `password` (str) - пароль (будет захеширован)
  - Возвращает созданный объект `Admin`.
  - Выдает ошибку 400, если имя пользователя уже существует.

- `PUT /api/admins/{admin_id}`:
  - Обновить существующего администратора по его ID.
  - Принимает объект `AdminUpdate` с опциональными полями:
    - `username` (str, опционально) - новое имя пользователя
    - `name` (str, опционально) - новое имя
    - `role` (str, опционально) - новая роль
    - `password` (str, опционально) - новый пароль (будет захеширован)
  - Возвращает обновленный объект `Admin`.
  - Выдает ошибку 404, если администратор не найден.

- `DELETE /api/admins/{admin_id}`:
  - Удалить администратора по его ID.
  - Возвращает сообщение об успешном удалении: `{"message": "Admin deleted successfully"}`.
  - Выдает ошибку 404, если администратор не найден.

### Сессии

- `DELETE /api/sessions/cleanup`:
  - Удалить все просроченные сессии из базы данных.
  - Возвращает объект с сообщением: `{"message": "Deleted {count} expired sessions"}`.
  - Используется для периодической очистки устаревших сессий.

### Служебные эндпоинты

- `GET /`:
  - Информация о сервисе.
  - Возвращает объект с полями: `service`, `version`, `status`.

- `GET /health`:
  - Проверка здоровья сервиса.
  - Возвращает объект с полем `status: "healthy"`.

## Особенности

- **JWT токены**: Используются JWT токены для аутентификации с временем жизни 24 часа.
- **Хеширование паролей**: Пароли хранятся в захешированном виде с использованием bcrypt.
- **Управление сессиями**: Все активные сессии хранятся в базе данных с указанием времени истечения.
- **Валидация токенов**: Проверка токенов включает как проверку подписи JWT, так и проверку наличия активной сессии в БД.
